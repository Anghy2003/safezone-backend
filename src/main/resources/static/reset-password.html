<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restablecer contraseña - SafeZone</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2b;
      --muted:#9aa4b2;
      --text:#eef2f7;
      --accent:#e53935;
      --accent2:#ff5a5a;
      --border:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(900px 600px at 30% 10%, rgba(229,57,53,.35), transparent 60%),
                  radial-gradient(900px 600px at 70% 30%, rgba(255,90,90,.22), transparent 60%),
                  var(--bg);
      color:var(--text);
      padding:24px;
    }
    .wrap{width:100%; max-width:440px;}
    .brand{display:flex; align-items:center; gap:12px; margin-bottom:16px;}
    .logo{
      width:44px; height:44px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--accent2), var(--accent));
      box-shadow: 0 18px 35px rgba(229,57,53,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
    }
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .card{
      background: rgba(15,26,43,.92);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow: 0 28px 60px rgba(0,0,0,.45);
      padding:18px 18px 16px;
    }
    .title{margin:0 0 6px;font-size:18px}
    .subtitle{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35}
    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px}
    input{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input:focus{border-color: rgba(229,57,53,.65); box-shadow:0 0 0 3px rgba(229,57,53,.18)}
    .row{display:flex; gap:10px; align-items:center; margin-top:12px}
    .btn{
      width:100%;
      border:0;
      border-radius:16px;
      padding:12px 14px;
      cursor:pointer;
      color:white;
      font-weight:700;
      font-size:14px;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      box-shadow: 0 18px 35px rgba(229,57,53,.35);
      transition: transform .06s ease;
    }
    .btn:active{transform:scale(.985)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; box-shadow:none}
    .hint{margin:10px 0 0; font-size:12px; color:var(--muted)}
    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      display:none;
      font-size:13px;
      line-height:1.35;
    }
    .msg.ok{display:block; background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.25)}
    .msg.err{display:block; background: rgba(229,57,53,.10); border-color: rgba(229,57,53,.25)}
    .small{font-size:12px;color:var(--muted);margin-top:14px}
    a{color:var(--accent2); text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo">SZ</div>
      <div>
        <h1>SafeZone</h1>
        <p>Restablecimiento de contraseña</p>
      </div>
    </div>

    <div class="card">
      <h2 class="title">Crear nueva contraseña</h2>
      <p class="subtitle">
        Ingresa una nueva contraseña para tu cuenta. El enlace expira según la configuración del sistema.
      </p>

      <div id="tokenWarn" class="msg err"></div>

      <form id="form">
        <label for="p1">Nueva contraseña</label>
        <input id="p1" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />

        <label for="p2">Confirmar contraseña</label>
        <input id="p2" type="password" placeholder="Repite la contraseña" autocomplete="new-password" />

        <div class="row">
          <button id="btn" class="btn" type="submit">Guardar contraseña</button>
        </div>

        <p class="hint">Consejo: usa al menos 8 caracteres y combina letras y números.</p>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>

        <p class="small">
          Si no solicitaste esto, simplemente cierra esta página.
        </p>
      </form>
    </div>
  </div>

  <script>
    // ✅ MISMA BASE que tu app móvil (ya incluye /api)
    const API_BASE = "https://safezone-backend-148831363300.us-central1.run.app/api";

    // Endpoint esperado en backend:
    // POST {API_BASE}/usuarios/reset-password
    // Body: { token: "...", newPassword: "..." }

    const qs = new URLSearchParams(location.search);
    const token = qs.get("token");

    const form = document.getElementById("form");
    const btn = document.getElementById("btn");
    const p1 = document.getElementById("p1");
    const p2 = document.getElementById("p2");

    const tokenWarn = document.getElementById("tokenWarn");
    const msgOk = document.getElementById("msgOk");
    const msgErr = document.getElementById("msgErr");

    function showErr(el, text){
      el.textContent = text;
      el.className = "msg err";
      el.style.display = "block";
    }
    function showOk(el, text){
      el.textContent = text;
      el.className = "msg ok";
      el.style.display = "block";
    }
    function hide(el){ el.style.display = "none"; el.textContent=""; }

    // Validar token en URL
    if (!token || token.trim().length < 10) {
      showErr(tokenWarn, "Enlace inválido o faltante (token). Vuelve a solicitar el restablecimiento de contraseña.");
      btn.disabled = true;
    } else {
      hide(tokenWarn);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(msgOk); hide(msgErr);

      const a = (p1.value || "").trim();
      const b = (p2.value || "").trim();

      if (a.length < 6) {
        return showErr(msgErr, "La contraseña debe tener mínimo 6 caracteres.");
      }
      if (a !== b) {
        return showErr(msgErr, "Las contraseñas no coinciden.");
      }

      btn.disabled = true;
      btn.textContent = "Guardando...";

      try {
        const res = await fetch(`${API_BASE}/usuarios/reset-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, newPassword: a })
        });

        const isJson = (res.headers.get("content-type") || "").includes("application/json");
        const data = isJson ? await res.json().catch(() => ({})) : {};

        if (!res.ok) {
          const msg = data.message || data.error || `Error (${res.status}) al actualizar la contraseña.`;
          throw new Error(msg);
        }

        showOk(msgOk, "Contraseña actualizada correctamente. Ya puedes volver a iniciar sesión en la app.");
        p1.value = "";
        p2.value = "";
      } catch (err) {
        showErr(msgErr, err.message || "Error desconocido");
      } finally {
        btn.disabled = false;
        btn.textContent = "Guardar contraseña";
      }
    });
  </script>
</body>
</html>
